= OAP HPE_ProLiant-Gen9 SmartArrayControllerアップデート手順書

:author: NTT Neomaite
:lang: ja
:icons: font
:doctype: book
:revnumber: 1.0版
:imagesdir: Images
:pdf-style: theme-page03.yml


<<<


== 改訂履歴
[cols="^1,^1,^2,^2,^10", options="header"]
|===
|No. |版 |日付 |種別 |内容
|1 a|1.0 a|2019/11/21 a|作成 a|初版
|2|-|-|-|-
|3|-|-|-|-
|4|-|-|-|-
|5|-|-|-|-
|===

<<<



== 目次
. 概要
. 事前準備
. VCSAとHPE ProLiant Gen9の正常性
.. VCSAの確認
.. HPE ProLiant Gen9の確認
. SmartArrayControllerアップデート
.. ESXiホストのメンテナンスモード有効化
.. SmartArrayControllerファームウェア適用
.. ESXiホストのメンテナンスモード解除
. バージョンアップ後の正常性

<<<

:toc:
:sectnums:
:toclevels: 5
// :toc-title: 目次





== 概要
　本手順書は、OAおよび、統合PFサービスが使用しているESXiホスト(HPE-ProLiant-Gen9)
のSmartArrayControllerファームウェアバージョンアップ作業を記載したものである。 +

バージョンアップ作業を実施する過程について、 +
SmartArrayControllerバージョン5.0は、予期しないリセットまたはシャットダウンが発生する事象を有している。 +
そのため、SmartArrayControlleのファームウェアバージョンアップを実施 +

本手順書は、以下のシステムを対象としてた手順である。

[cols="1,1",width="80%"]
|===================
|対象機器 | HPE ProLiant BL460c Gen9
|対象バージョン | SmartArrayController v5.0
|アップデートバージョン | SmartArrayController v7.0
|HPEサポート情報 | https://support.hpe.com/hpsc/doc/public/display?docId=emr_na-a00060570en_us[(改訂版) ProLiant Gen9シリーズサーバー - ProLiant Gen9サーバーで予期しないリセットまたはシャットダウンが発生することがある]
|ダウンロードURL | https://support.hpe.com/hpsc/swd/public/detail?swItemId=MTX_a836abab16874bb7bd31cad773[オンラインROMフラッシュコンポーネント for VMware - HPE ProLiant BL460c Gen9/WS460c Gen9 (I36) サーバー]
|===================

<<<




== 事前準備
作業前に以下の項を満たしていること

* ダウンロードURLからファームバージョン7.0のファイルをダウンロードできていること

* サービスおよび監視装置に異常がないこと

* VCSAおよびHPE Onboard Administratorまたは、HPE OneViewにアクセスできる端末があること

<<<



== VCSAとHPE ProLiant Gen9の正常性
=== VCSA正常性確認
以下の手順を確認し、VCに異常がないことを確認

. 対象VCSAに接続し、ログインする
+
image:01_vcsa1.JPG[600,580]


. [`アラーム`]に警告以上イベントが表示されていないことを確認
+
image:01_vcsa2.JPG[600,580]


. [ホーム] -> [ホストおよびクラスタ] -> [VCSA名 or IP] -> [監視タブ] -> [`問題`]に何も表示されないことを確認
+
image:01_vcsa3.JPG[600,580]


. [ホーム] -> [ホストおよびクラスタ] -> [VCSA名 or IP] -> [監視タブ] -> [`タスクおよびイベント`]にて、警告以上のステータスが表示されていないことを確認
+
image:01_vcsa4.JPG[600,580]


. [ホーム] -> [`イベント`]のタイプに警告以上のログが出力されていないことを確認
+
image:01_vcsa5.JPG[600,580]

以上で、 +
VCSA正常性確認は、完了です。




=== HPE ProLiant Gen9の確認
以下の手順を実施し、ファームバージョンや機器の状態確認し、問題ない事を確認する

. 対象OneViewまたは"HPE Onboard Administrator"にログインする
+
image:02_iLO1.JPG[600,580]
+
[.small]#_図 HPE Blade System Onboard Administrator_#
+
image:02_iLO2.JPG[600,580]
+
[.small]#_図 HPE OneView_#
+

. 対象iLOに接続する
+
image:02_iLO3.JPG[600,580]
+
[.small]#_図 HPE Blade System Onboard Administrator_#
+
image:02_iLO4.JPG[600,580]
+
[.small]#_図 HPE OneView_#
+


. 概要(Oneview) のステータスが正常なこと
+
image:02_iLO5.JPG[600,580]


. システム情報(System Information) の各項目(各タブ)が正常なことを確認
+
image:02_iLO6.JPG[600,580]


. システム情報(System Information) -> [Firmware] -> [Smart Array P440ar Controller]のファームバージョンを確認
+
image:02_iLO7.JPG[600,580]


. [iLO Event Log] -> [View CSV]で、すべてのイベントログを取得する
+
image:02_iLO8.JPG[600,580]


. [Integrated Management Log] -> [View CSV]で、すべてのイベントログを取得する
+
image:02_iLO9.JPG[600,580]


以上で、 +
HPE ProLiant Gen9の確認は、完了です


<<<


== SmartArrayControllerアップデート
=== ESXiホストのメンテナンスモード有効化
ファームウェアをバージョンアップ実施後、再起動を実施するため、ESXiホストをメンテナンスモードに移行する

. [ホーム] -> [ホストおよびクラスタ] -> [VCSA名 or IP] -> [Datacenter] -> [Cluster] -> [`対象のESXiホスト`]を選択
+
image:03_esxi1.jpg[600,580]


. [`仮想マシン`]を選択し、起動している仮想VMが起動していないことを確認 +
+
image:03_esxi2.jpg[600,580]
+
+

[NOTE]
====
起動している仮想VMがある場合、 別ESXiホストに仮想VM(起動VM)を移動させる
====

[WARNING]
====
必ずメンテナンスモードに移行するESXiホストには、パワーオンしている仮想VMがいないこと
====

. [アクション] -> [メンテナンスモード] -> [`メンテナンスモード切り替え`]を実行
. タスクにて、実行結果が完了と表示されていることを確認
+
image:03_esxi3.jpg[600,580]


. 対象ESXiホストにメンテナンスモードと表示されていることを確認
+
image:03_esxi4.jpg[600,580]


以上で、 +
ESXiホストのメンテナンスモード有効化作業は、完了です



=== SmartArrayControllerファームウェア適用
ファームウェアのバージョン7.00にアップデートを実施する

1. WINSCPやTeraTerm等のアプリケーションを使用し、事前にダウンロードしたファームウェアファイルを対象ESXiホストにアップロード

2. 対象ESXiホストにSSH接続し、アップロードした場所に移動

[source,sh]
----
cd /tmp/
ls -l
----

3 . ZIPファイルを解凍

[source,sh]
----
unzip ./CP039996.zip
----

4 . ファームウェアプログラムに実行権限付与 +

[source,sh]
----
chmod 755 CP039996.vmexe
----

5 . ファームウェアプログラムを実行 +

[source,sh]
----
./CP039996.vmexe
----

6 . 以下のメッセージが表示後、[A]を入力し、Enterを押下 +

"Select which devices to flash [# ,#- #,(A)ll,(N)one]> "


7 . 以下のメッセージを確認し、バージョンアップが問題なく成功したことを確認 +

"AUX Power Cycle request sent successfully." +
"Smart Component Finished"


8 . 再起動を実施

[source,sh]
----
reboot
----

実行例
[source,sh]
----
include::worklog/04_SARC1.log[]
----

以上で、 +
SmartArrayControllerファームウェア適用作業は、完了です



=== ESXiホストのメンテナンスモード解除
バージョンアップ作業のため、ESXiホストをメンテナンスモードに移行したので、メンテナンスモード解除を行う

. [ホーム] -> [ホストおよびクラスタ] -> [VCSA名 or IP] -> [Datacenter] -> [Cluster] -> [`対象のESXiホスト`]を選択
+
image:03_esxi1.jpg[600,580]

. [アクション] -> [メンテナンスモード] -> [メンテナンスモード終了]を実行
. タスクにて、実行結果が完了と表示されていることを確認
+
image:03_esxi5.jpg[600,580]


. 対象ESXiホストにメンテナンスモードと #表示されていない# ことを確認
+
image:03_esxi1.jpg[600,580]


以上で、 +
ESXiホストのメンテナンスモード解除作業は、完了です

<<<



== バージョンアップ後の正常性
以下の手順を実施し、ファームバージョンや機器状態確認し、問題ない事を確認する

. 対象OneViewまたは"HPE Onboard Administrator"にログインする
+
image:02_iLO1.JPG[600,580]
+
[.small]#_図 HPE Blade System Onboard Administrator_#
+
image:02_iLO2.JPG[600,580]
+
[.small]#_図 HPE OneView_#
+

. 対象iLOに接続する
+
image:02_iLO3.JPG[600,580]
+
[.small]#_図 HPE Blade System Onboard Administrator_#
+
image:02_iLO4.JPG[600,580]
+
[.small]#_図 HPE OneView_#
+


. 概要(Oneview) のステータスが正常なことを確認
+
image:02_iLO5.JPG[600,580]


. システム情報(System Information) の各項目(各タブ)が正常なことを確認
+
image:02_iLO6.JPG[600,580]


. システム情報(System Information) -> [Firmware] -> [Smart Array P440ar Controller]のファームバージョンが #7.00# と表示されていることを確認
+
image:02_iLO10.jpg[600,580]


以上で、 +
バージョンアップ後の正常性作業は、完了です +
上記の行程で、SmartArrayControllerアップデート作業は、全て完了です
