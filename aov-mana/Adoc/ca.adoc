= AzureStack証明書更新: 標準レイアウト
:author: NTT Neomaite
:lang: ja
:icons: font
:doctype: book
:source-highlighter: highlightjs



<<<

// = AzureStack証明書更新


== 改訂履歴
[cols="^1,^1,^2,^2,^10", options="header"]
|===
|No. |版 |日付 |種別 |内容
|1 a|1.0 a|2019/10/30 a|作成 a|初版
|2|-|-|-|-
|3|-|-|-|-
|4|-|-|-|-
|5|-|-|-|-
|===

<<<


== 目次
. 概要
. 事前準備
. AzS正常性確認
. 相互共有ディレクトリ作成
. 更新証明書のセット
. PEP作成
. シークレットローテーション実行
. 証明書更新の正常性確認

<<<

:toc:
:sectnums:
:toclevels: 5
:figure-caption: 図
:table-caption: 表
:pagenums:
// :toc-title: 目次





== 概要
本手順書は、AzS証明書更新作業のへ証明書適用手順について記載したものである。 + 
本手順書は、以下のシステムを対象としてた手順である。

[cols="1,1",width="80%"]
|===================
|対象システム | Azure Stack
|作業ポータル | 管理者ポータル
|対象バージョン(Azure Stack) | 1.1905以降
|参考URL | https://docs.microsoft.com/ja-jp/azure/azure-stack/azure-stack-rotate-secrets[Microsoft: AzureStackでシークレットをローテーションする]
|===================    
<<<


== 事前準備
作業前に以下の項を満たしていることを確認

* 前手順（AzS証明書の証明書更新　証明書の作成）で、作成した証明書が用意できていること

* 前手順（AzS証明書の証明書更新　証明書の作成）で、証明書テストコマンドにすべて合格していること

* ERCSサーバ（特権エンドポイント）にアクセスできる端末に接続、およびログインできること

* 上記の端末で、Powershellを起動、AzSモジュールをインポートし、AzSコマンドが使用可能なこと +
(手順「PowerShellのインストール方法」を参照) +



== AzS正常性確認
AzureStack自己診断ツールを実行し、結果出力がすべて正常であることを確認

. ERCSサーバ（特権エンドポイント）にアクセスできる端末に接続
. Powershellを起動、AzSモジュールをインポート
. 以下のコマンドを実行し、診断の結果がすべてPASSされる事を確認

----
# ERCS LoginAccount
$Cred = Get-Credential 
----
// icon:fas fa-info-circle fa-1x[] _アカウントは、クラウド管理者(CloudAdmin)のID、PWを入力_ +
// TIP: 補足
[TIP]
===============================
[small]#_AzSクラウド管理者(CloudAdmin)のID、PWを入力_#
===============================

----
# login to a PEPSession 
Enter-PSSession -ComputerName "ERCサーバ名 or ipアドレス" -ConfigurationName PrivilegedEndpoint -Credential $Cred
----

----
# Running the Test-Azurestack
Test-AzureStack
----

[caption="Custom: "]
==========================

*例)* + 
PS C:\ > $Cred = Get-Credential + 
PS C:\ > Enter-PSSession -ComputerName "172.31.254.225" -ConfigurationName PrivilegedEndpoint -Credential $Cred +

[172.31.254.225]: PS C:\ >  +
[172.31.254.225]: PS C:\ > Test-AzureStack  +

10/23/2019 06:43:01 : Starting Test-AzureStack
10/23/2019 06:43:25 : Launching AzsInfraPerformance
10/23/2019 06:46:52 : PASS : Azure Stack Infrastructure Role Instance Performance +
... +
... +
PASS Azure Stack Storage Job Summary  +
PASS Azure Stack Storage SubSystem Summary +
PASS Azure Stack Storage Pool Summary +
PASS Azure Stack Storage Virtual Disk Summary +
PASS Azure Stack Storage Cluster Shared Volume Summary +
PASS Azure Stack Storage Volume Summary +
PASS Azure Stack Storage File Share Summary +
PASS Azure Stack Storage Services Physical Disks Summary +
 +
True +

[172.31.254.225]: PS > 

==========================
<<<



== 相互共有ディレクトリ作成
ERCSサーバ（特権エンドポイント）からアクセスできる共有フォルダ設定し、更新に必要なディレクトリ構成を作成

. 任意のフォルダに、共有フォルダ設定を行う +
 (セキュリティー設定については、CloudAdmin_IDで読み書き可能な事) 

. https://www.aka.ms/azssecretrotationhelper[AzureStackHelper]から「CertDirectoryMaker.ps1」をDLし、共有フォルダに保存

. Powershellにて、設定した共有フォルダに移動し、「CertDirectoryMaker.ps1」を実行


+
==========================    
*例)* + 
PS C:\ > cd c:\Azs + 
PS C:\Azs > ./CertDirectoryMaker.ps1 +
==========================
+

証明書更新に必要なディレクトリ作成できている事を確認



[NOTE]
==========================

共有フォルダ構造が、Certificatesフォルダーで始まっていることが重要 +
そうでない場合も、検証が失敗する +
共有のマウントは、 \\<IP アドレス>\<共有名>\ のようになっている必要があり、 +
内部にCertificates\AAD または、 Certificates\ADFSフォルダーが含まれる必要がある +
 +
例: +
Fileshare = \\<IP アドレス>\<共有名>\ +
CertFolder = Certificates\AAD +
FullPath = \\<IP アドレス>\<共有名>\Certificates\AAD
    
==========================


. ファイル共有フォルダ構造が、以下である事を確認



== 更新証明書のセット

[plantuml, diag-sequence-sample]
----
@startuml
ClassA -> ClassB: Call
ClassB -> ClassC: Call
ClassC --> ClassB: Response
ClassB --> ClassA: Response
@enduml
----



== PEP作成
== シークレットローテーション実行
== 証明書更新の正常性確認












// 参考
// [source,powershell]
// ----
// PS C:\> $Cred = Get-Credential 
// PS C:\> Enter-PSSession -ComputerName "ERCサーバ名 or ipアドレス" -ConfigurationName // // PrivilegedEndpoint -Credential $Cred
// 
// [ERCS-Server]: PS C:\>
// [ERCS-Server]: PS C:\> Test-AzureStack
// 
// 08/23/2019 06:43:01 : Starting Test-AzureStack
// 08/23/2019 06:43:25 : Launching AzsInfraPerformance
// 08/23/2019 06:46:52 : PASS : Azure Stack Infrastructure Role Instance Performance
// ...
// ...
// ...
// ----






